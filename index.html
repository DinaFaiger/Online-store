<!DOCTYPE html>
<html lang="he">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>×—× ×•×ª ×“×™×’×™×˜×œ×™×ª</title>
  <!-- ×§×™×©×•×¨ ×œ×§×•×‘×¥ CSS ×—×™×¦×•× ×™ ×œ×¢×™×¦×•×‘ -->
  <link rel="stylesheet" href="index.css">
</head>

<body>
  <!-- ×¡×¨×’×œ × ×™×•×•×˜ ×¢×œ×™×•×Ÿ ×¢× ×œ×•×’×•, ×—×™×¤×•×©, ×¡×œ ×§× ×™×•×ª ×•×›× ×™×¡×” -->
  <nav>
    <div class="nav-header">
      <!-- ×œ×•×’×• ×”×—× ×•×ª -->
      <a href="index.html">
        <img src="image/logo.png" class="logo-img" alt="×œ×•×’×• ×”×—× ×•×ª" />
      </a>

      <!-- ×ª×™×‘×ª ×—×™×¤×•×© ××•×¦×¨×™× -->
      <div class="nav-search">
        <input type="text" id="searchBox" placeholder="×—×™×¤×•×© ××•×¦×¨..." autocomplete="off" />
        <span style="font-size:1.2rem;color:#6c49ff;">ğŸ”</span>
      </div>
      <!-- ×¤×¢×•×œ×•×ª ××©×ª××©: ×¡×œ ×§× ×™×•×ª, ××•×•×˜×¨, ×”×ª×—×‘×¨×•×ª -->
      <div class="nav-actions">
        <!-- ×›×¤×ª×•×¨ ××¢×‘×¨ ×œ×¡×œ ×”×§× ×™×•×ª -->
        <button class="cart-btn" onclick="window.location.href='cart.html'">
          <span class="cart-count" id="cartCount">0</span> ğŸ›’ ×¡×œ
        </button>
        <!-- ×”×¦×’×ª ××•×•×˜×¨ ××©×ª××© ××—×•×‘×¨ -->
        <div class="user-avatar" id="userAvatar" style="display:none;">
          <span id="avatarInitial"></span>
          <div class="user-dropdown" id="userDropdown">
            <button onclick="goToProfile()">×¤×¨×˜×™× ××™×©×™×™×</button>
            <button onclick="logoutUser()">×”×ª× ×ª×§</button>
          </div>
        </div>
        <!-- ×›×¤×ª×•×¨ ×”×ª×—×‘×¨×•×ª -->
        <button class="login-btn" id="loginBtn" onclick="showLoginPopup()">×”×ª×—×‘×¨</button>
      </div>
    </div>
    <!-- ×ª×¤×¨×™×˜ ×¨××©×™ ×©×œ ×§×˜×’×•×¨×™×•×ª -->
    <ul class="menu" id="mainMenu"></ul>
  </nav>

  <!-- ×‘×× ×¨ ××‘×¦×¢×™× ×¨×¥ -->
  <section id="promoBanner" class="promo-container" style="position: relative;">
    <div class="sale-animation">
      <img src="image/sale.png" alt="××‘×¦×¢">
    </div>
    <div class="promo-slider" id="promoTrack"></div>
  </section>

  <main>
    <!-- ×›×•×ª×¨×ª ×§×˜×’×•×¨×™×”/×—×™×¤×•×© -->
    <div class="products-title" id="productsTitle"></div>
    <!-- ××–×•×¨ ×”×¦×’×ª ×›×¨×˜×™×¡×™ ××•×¦×¨×™× -->
    <div class="products-container" id="productsContainer"></div>
    <!-- ×›×¤×ª×•×¨ ×˜×¢×™× ×ª ×¢×•×“ ××•×¦×¨×™× -->
    <button class="load-more-btn" id="loadMoreBtn" style="display:none;" onclick="loadMoreProducts()">×˜×¢×Ÿ ×¢×•×“
      ××•×¦×¨×™×</button>
  </main>

  <!-- ×¤×•×˜×¨ ×œ×™×¦×™×¨×ª ×§×©×¨ -->
  <footer>
    ×™×¦×™×¨×ª ×§×©×¨: <b>support@onlineShop.co.il</b> | ×™×© ×œ×š ×©××œ×”? <a href="mailto:support@onlineShop.co.il">×¤× ×” ××œ×™× ×•</a>
  </footer>

  <script>
    // --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
    // ××–×”×” ×”-BIN ×•×”-API KEY ×œ×©××™×¨×ª ××©×ª××©×™×/×¡×œ×™× ×‘-jsonbin.io
    const BIN_ID = "687d68e6fdac391a2ff106cd";
    const API_KEY = "$2a$10$jUdVbRFsQ.nFPu9sdEhLGuFKyLKnsopNmK7f9K2anJSQ3noWGvHMq";

    // ××™×¤×•×™ ×§×˜×’×•×¨×™×•×ª ×¨××©×™×•×ª ×•×ª×ª×™ ×§×˜×’×•×¨×™×•×ª
    const categories = {
      '× ×©×™×': ['womens-dresses', 'womens-shoes', 'womens-watches', 'womens-bags', 'womens-jewellery'],
      '×’×‘×¨×™×': ['mens-shirts', 'mens-shoes', 'mens-watches'],
      '×˜×›× ×•×œ×•×’×™×”': ['smartphones', 'laptops', 'tablets', 'mobile-accessories'],
      '×™×•×¤×™': ['beauty', 'skin-care', 'fragrances'],
      '×œ×‘×™×ª': ['furniture', 'home-decoration', 'kitchen-accessories'],
      '×¡×•×¤×¨': ['groceries'],
      '××‘×™×–×¨×™×': ['sports-accessories', 'sunglasses'],
      '×¨×›×‘': ['motorcycle', 'vehicle'],
      '××•×¤× ×”': ['tops']
    };

    // ××™×¤×•×™ ×©× ×ª×¦×•×’×” ×¢×‘×¨×™ ×œ×›×œ ×ª×ª-×§×˜×’×•×¨×™×”
    const catDisplay = {
      'womens-dresses': '×©××œ×•×ª × ×©×™×',
      'womens-shoes': '× ×¢×œ×™ × ×©×™×',
      'womens-watches': '×©×¢×•× ×™ × ×©×™×',
      'womens-bags': '×ª×™×§×™ × ×©×™×',
      'womens-jewellery': '×ª×›×©×™×˜×™ × ×©×™×',
      'mens-shirts': '×—×•×œ×¦×•×ª ×’×‘×¨×™×',
      'mens-shoes': '× ×¢×œ×™ ×’×‘×¨×™×',
      'mens-watches': '×©×¢×•× ×™ ×’×‘×¨×™×',
      'smartphones': '×¡×××¨×˜×¤×•× ×™×',
      'laptops': '××—×©×‘×™× × ×™×™×“×™×',
      'tablets': '×˜××‘×œ×˜×™×',
      'mobile-accessories': '××‘×™×–×¨×™ ××•×‘×™×™×œ',
      'beauty': '×™×•×¤×™',
      'skin-care': '×˜×™×¤×•×— ×”×¢×•×¨',
      'fragrances': '×‘×©××™×',
      'furniture': '×¨×”×™×˜×™×',
      'home-decoration': '×¢×™×¦×•×‘ ×”×‘×™×ª',
      'kitchen-accessories': '××‘×™×–×¨×™ ××˜×‘×—',
      'groceries': '××›×•×œ×ª',
      'sports-accessories': '××‘×™×–×¨×™ ×¡×¤×•×¨×˜',
      'sunglasses': '××©×§×¤×™ ×©××©',
      'motorcycle': '××•×¤× ×•×¢×™×',
      'vehicle': '×¨×›×‘×™×',
      'tops': '×—×•×œ×¦×•×ª ×•×˜×•×¤×™×'
    };

    // --- ×¤×•× ×§×¦×™×•×ª × ×™×”×•×œ ××©×ª××©×™× ×•×¡×œ ×§× ×™×•×ª ---

    // ×‘×“×™×§×” ×”×× ×™×© ××©×ª××© ××—×•×‘×¨
    function isUserLoggedIn() {
      return !!localStorage.getItem('user');
    }
    // ×©×œ×™×¤×ª ××•×‘×™×™×§×˜ ×”××©×ª××© ××”-localStorage
    function getUser() {
      try {
        return JSON.parse(localStorage.getItem('user') || '{}');
      } catch {
        return {};
      }
    }
    // ×©××™×¨×ª ××©×ª××© ×œ-localStorage
    function setUser(userObj) {
      localStorage.setItem('user', JSON.stringify(userObj));
    }
    // ××—×™×§×ª ××©×ª××© ××”-localStorage
    function clearUser() {
      localStorage.removeItem('user');
    }

    // ×”×¦×’×ª ×”××•×•×˜×¨ ×›××©×¨ ××©×ª××© ××—×•×‘×¨
    function setAvatar() {
      const user = getUser();
      let displayName = user.username || '';
      const loginBtn = document.getElementById('loginBtn');
      const userAvatar = document.getElementById('userAvatar');
      const avatarInitial = document.getElementById('avatarInitial');
      if (loginBtn) loginBtn.style.display = 'none';
      if (userAvatar) userAvatar.style.display = 'inline-flex';
      if (avatarInitial) avatarInitial.textContent = displayName.charAt(0) || '×';
    }

    // ×¢×“×›×•×Ÿ ×¡×¤×™×¨×ª ×¤×¨×™×˜×™× ×‘×¡×œ ×§× ×™×•×ª
    function updateCartCount() {
      let cart = getUserCart();
      let sum = cart.reduce((a, b) => a + (b.quantity || 1), 0);
      const cartCountEl = document.getElementById('cartCount');
      if (cartCountEl) cartCountEl.textContent = sum;
    }

    // ×©×œ×™×¤×ª ×¡×œ ×§× ×™×•×ª ×©×œ ×”××©×ª××©
    function getUserCart() {
      let user = JSON.parse(localStorage.getItem('user') || '{}');
      return Array.isArray(user.cart) ? user.cart : [];
    }

    // --- ×”×•×¡×¤×ª ××•×¦×¨ ×œ×¡×œ ×§× ×™×•×ª (×›×•×œ×œ ××‘×¦×¢) ---
    async function addToCart(id, title, thumbnail, price, event, promoPrice = null) {
      if (!isUserLoggedIn()) {
        showLoginPopup();
        return;
      }
      let user = getUser();
      let cart = Array.isArray(user.cart) ? user.cart : [];

      // ×‘×“×™×§×” ×”×× ×”××•×¦×¨ ×›×‘×¨ ×‘×¡×œ
      let existing = cart.find(item => item.id === id);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({
          id,
          title,
          thumbnail,
          price: promoPrice !== null ? promoPrice : price, // ×©××™×¨×ª ××—×™×¨ ××‘×¦×¢ ×× ×™×©
          originalPrice: price,
          quantity: 1
        });
      }

      user.cart = cart;
      user.cartUpdatedAt = Date.now();
      setUser(user);
      updateCartCount();

      // ×× ×™××¦×™×”/×”×•×“×¢×” ×‘×›×¤×ª×•×¨ ×”×•×¡×¤×” ×œ×¡×œ
      if (event) {
        const btn = event.target || event;
        const originalText = btn.textContent;
        const originalBg = btn.style.background;
        btn.textContent = promoPrice !== null ? "× ×•×¡×£ ×œ××‘×¦×¢ âœ“" : "× ×•×¡×£ ×œ×¡×œ âœ“";
        btn.style.background = "#4CAF50"; // ×™×¨×•×§
        btn.disabled = true;
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = originalBg;
          btn.disabled = false;
        }, 1500);
      }

      // ×©××™×¨×” ×œ×©×¨×ª BIN (jsonbin)
      setTimeout(async () => {
        try {
          const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { "X-Master-Key": API_KEY }
          });
          const data = await res.json();
          const users = data.record.users || [];
          let idx = users.findIndex(u => u.username === user.username);
          if (idx !== -1) {
            users[idx].cart = cart;
            users[idx].cartUpdatedAt = user.cartUpdatedAt;
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "X-Master-Key": API_KEY
              },
              body: JSON.stringify({ users })
            });
          }
        } catch (err) {
          console.warn('×©×’×™××” ×‘×©××™×¨×ª ×”×¡×œ:', err);
        }
      }, 200);
    }

    // ×”×•×¡×¤×ª ××•×¦×¨ ××”×—×œ×•×Ÿ ×©×œ ××‘×¦×¢
    function addToCartFromWindowPromo(productKey, buttonElement) {
      const productData = window[productKey];
      if (productData) {
        addToCart(
          productData.id,
          productData.title,
          productData.thumbnail,
          productData.price,
          buttonElement,
          productData.promoPrice
        );
      }
    }

    // --- ×‘× ×™×™×ª ×ª×¤×¨×™×˜ ×§×˜×’×•×¨×™×•×ª ×¨××©×™ ×•×“×™× ××™ ---
    function buildMenu() {
      const mainMenu = document.getElementById('mainMenu');
      if (!mainMenu) return;

      mainMenu.innerHTML = '';
      Object.entries(categories).forEach(([mainCat, subcats]) => {
        let li = document.createElement('li');
        li.className = 'menu-item';
        li.tabIndex = 0;
        li.textContent = mainCat;

        li.onclick = async () => {
          closeAllMenus();
          document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('selected'));
          li.classList.add('selected');
          let allProducts = [];
          for (let cat of subcats) {
            try {
              const res = await fetch(`https://dummyjson.com/products/category/${cat}`);
              const data = await res.json();
              allProducts = allProducts.concat(data.products || []);
            } catch (err) {
              console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×§×˜×’×•×¨×™×”:', cat, err);
            }
          }
          renderProducts(allProducts);
          document.getElementById('productsTitle').textContent = '×›×œ ×”××•×¦×¨×™× ×‘×§×˜×’×•×¨×™×”: ' + mainCat;
          document.getElementById('loadMoreBtn').style.display = 'none';
        };

        // ×‘× ×™×™×ª ×ª×¤×¨×™×˜ ××©× ×” (×ª×ª×™ ×§×˜×’×•×¨×™×•×ª)
        if (subcats.length) {
          let submenu = document.createElement('ul');
          submenu.className = 'submenu';
          subcats.forEach(sc => {
            let btn = document.createElement('button');
            btn.className = 'submenu-btn';
            btn.textContent = catDisplay[sc];
            btn.onclick = (e) => {
              e.stopPropagation();
              closeAllMenus();
              document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('selected'));
              li.classList.add('selected');
              loadProducts(sc, true);
              document.getElementById('productsTitle').textContent = '×›×œ ×”××•×¦×¨×™× ×‘×§×˜×’×•×¨×™×”: ' + catDisplay[sc];
              document.getElementById('loadMoreBtn').style.display = 'none';
            };
            submenu.appendChild(btn);
          });
          li.appendChild(submenu);
          li.addEventListener('mouseenter', () => {
            closeAllMenus();
            li.classList.add('open');
          });
          li.addEventListener('mouseleave', () => {
            li.classList.remove('open');
          });
        }
        mainMenu.appendChild(li);
      });
    }
    // ×¡×’×™×¨×ª ×›×œ ×”×ª×¤×¨×™×˜×™× (××©× ×”)
    function closeAllMenus() {
      document.querySelectorAll('.menu-item.open').forEach(el => el.classList.remove('open'));
    }

    // --- ×˜×¢×™× ×ª ××•×¦×¨×™× ×“×™× ×××™×ª ---
    let allProducts = [], currPage = 0, currCat = '', isLoading = false, hasMoreProducts = true;
    const PRODUCTS_PER_PAGE = 20;
    async function loadProducts(cat = '', reset = true) {
      if (isLoading) return;
      isLoading = true;
      updateLoadMoreButton();

      try {
        if (reset) {
          currCat = cat;
          currPage = 0;
          allProducts = [];
          hasMoreProducts = true;
          const container = document.getElementById('productsContainer');
          if (container) container.innerHTML = '<div style="text-align:center;padding:2rem;color:#6c49ff;font-size:1.2rem;">×˜×•×¢×Ÿ ××•×¦×¨×™×...</div>';
        }

        let skip = currPage * PRODUCTS_PER_PAGE;
        let url = cat
          ? `https://dummyjson.com/products/category/${cat}?limit=${PRODUCTS_PER_PAGE}&skip=${skip}`
          : `https://dummyjson.com/products?limit=${PRODUCTS_PER_PAGE}&skip=${skip}`;

        const res = await fetch(url);
        const data = await res.json();
        let products = data.products || [];

        allProducts = reset ? products : [...allProducts, ...products];
        hasMoreProducts = products.length === PRODUCTS_PER_PAGE;
        currPage++;

        renderProducts(allProducts);
      } catch (err) {
        const container = document.getElementById('productsContainer');
        if (container) {
          container.innerHTML = '<div style="text-align:center;padding:2rem;color:#fd52af;">×©×’×™××” ×‘×˜×¢×™× ×ª ×”××•×¦×¨×™×</div>';
        }
      } finally {
        isLoading = false;
        updateLoadMoreButton();
      }
    }
    // ×˜×¢×™× ×ª ×¢××•×“ × ×•×¡×£ ×©×œ ××•×¦×¨×™×
    function loadMoreProducts() {
      const searchBox = document.getElementById('searchBox');
      if (searchBox && searchBox.value.trim()) return;
      if (isLoading) {
        isLoading = false;
        return;
      }
      loadProducts(currCat, false).catch(() => {
        isLoading = false;
        updateLoadMoreButton();
      });
    }
    // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×›×¤×ª×•×¨ "×˜×¢×Ÿ ×¢×•×“ ××•×¦×¨×™×"
    function updateLoadMoreButton() {
      const btn = document.getElementById('loadMoreBtn');
      if (!btn) return;
      if (hasMoreProducts && allProducts.length > 0) {
        btn.style.display = 'block';
        btn.disabled = isLoading;
        btn.textContent = isLoading ? '×˜×•×¢×Ÿ...' : '×˜×¢×Ÿ ×¢×•×“ ××•×¦×¨×™×';
      } else {
        btn.style.display = 'none';
      }
    }

    // --- ×”×¦×’×ª ×›×¨×˜×™×¡×™ ××•×¦×¨×™× ×‘×“×£ ×”×¨××©×™ ---
    function renderProducts(products) {
      const container = document.getElementById('productsContainer');
      if (!container) return;
      if (!products || products.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:2rem;color:#6c49ff;">×œ× × ××¦××• ××•×¦×¨×™×</div>';
        return;
      }

      const html = products.map((prod, index) => {
        const productKey = `product_${prod.id}_${index}`;
        window[productKey] = {
          id: prod.id,
          title: prod.title,
          thumbnail: prod.thumbnail,
          price: prod.price,
          promoPrice: null
        };

        const safeTitle = (prod.title || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const safeThumbnail = (prod.thumbnail || '').replace(/"/g, '&quot;');

        return `
        <div class="product-card">
          <a href="product.html?id=${prod.id}&promo=${prod.promoPrice}" style="text-decoration: none; color: inherit; display: block;">
            <img src="${safeThumbnail}" alt="${safeTitle}" class="product-img" onerror="this.src='https://via.placeholder.com/100x100?text=No+Image'">
            <h3 class="product-title">${safeTitle}</h3>
            <p class="product-price">$${prod.price || 0}</p>
          </a>
          <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCartFromWindowPromo('${productKey}', this)">×”×•×¡×£ ×œ×¡×œ ğŸ›’</button>
        </div>
      `;
      }).join('');

      container.innerHTML = html;
    }

    // --- ×˜×¢×™× ×ª ××•×¦×¨×™× ×¢× ××‘×¦×¢ ×œ×¡×¨×˜ ×”××‘×¦×¢×™× ---
    async function loadPromoProducts() {
      try {
        let allPromoCandidates = [];
        const categoryArrays = Object.values(categories);
        const flatCategories = categoryArrays.flat();

        // ×§×¨×™××•×ª ××§×‘×™×œ×•×ª ×œ×›×œ ×”×§×˜×’×•×¨×™×•×ª
        const fetches = flatCategories.map(cat => fetch(`https://dummyjson.com/products/category/${cat}?limit=20`));
        const results = await Promise.all(fetches);

        for (const res of results) {
          const data = await res.json();
          allPromoCandidates = allPromoCandidates.concat(data.products || []);
        }

        // ×‘×—×™×¨×ª 10 ××•×¦×¨×™× ××§×¨××™×™×
        const selected = getRandomUnique(allPromoCandidates, 10);
        selected.forEach(prod => {
          prod.promoPrice = Math.round(prod.price * 0.9);
        });

        renderPromoBanner(selected);
      } catch (err) {
        console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ××‘×¦×¢×™×:', err);
      }
    }

    // --- ×©×œ×™×¤×ª n ××•×¦×¨×™× ××§×¨××™×™× ××”××¢×¨×š ---
    function getRandomUnique(arr, n) {
      const result = [];
      const taken = new Set();
      while (result.length < n && result.length < arr.length) {
        const idx = Math.floor(Math.random() * arr.length);
        if (!taken.has(idx)) {
          taken.add(idx);
          result.push(arr[idx]);
        }
      }
      return result;
    }

    // --- ×”×¦×’×ª ×¡×¨×˜ ×”××‘×¦×¢×™× (×§××¨×•×¡×œ ××•×¦×¨×™×) ---
    function renderPromoBanner(products) {
      const promoTrack = document.getElementById('promoTrack');
      if (!promoTrack) return;

      const html = products.map((prod, index) => {
        const productKey = `promo_product_${prod.id}_${index}`;
        window[productKey] = prod;

        return `
        <div class="promo-item">
          <div class="promo-badge">10% ××‘×¦×¢</div>
      <a href="product.html?id=${prod.id}&promo=${prod.promoPrice}" style="text-decoration: none; color: inherit; display: block;">
            <img src="${prod.thumbnail}" alt="${prod.title}">
            <div class="promo-title">${prod.title}</div>
            <div>
              <span class="promo-price">$${prod.promoPrice}</span>
              <span class="promo-original-price">$${prod.price}</span>
            </div>
          </a>
          <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCartFromWindowPromo('${productKey}', this)">×”×•×¡×£ ×œ××‘×¦×¢ ğŸ›’</button>
        </div>
      `;
      }).join('');

      // ×©×›×¤×•×œ ×”×ª×•×›×Ÿ ×›×“×™ ×œ×™×¦×•×¨ ×¨×™×¦×” ××™× ×¡×•×¤×™×ª ×©×œ ×”××‘×¦×¢×™×
      promoTrack.innerHTML = html + html;
    }

    // --- ×× ×™××¦×™×™×ª ×’×œ×™×œ×” ××•×˜×•××˜×™×ª ×œ×¡×¨×˜ ×”××‘×¦×¢×™× ---
    function animatePromoBanner(container) {
      let scrollPos = 0;
      const speed = 0.5; // ××”×™×¨×•×ª ×’×œ×™×œ×”

      // × ×“×‘×™×§ ××ª ×”×ª×•×›×Ÿ ×¤×¢××™×™× ×›×“×™ ×œ××¤×©×¨ ×œ×•×œ××” ××™× ×¡×•×¤×™×ª
      container.innerHTML += container.innerHTML;
      const scrollWidth = container.scrollWidth / 2;

      function step() {
        scrollPos += speed;
        if (scrollPos >= scrollWidth) scrollPos = 0;
        container.scrollLeft = scrollPos;
        requestAnimationFrame(step);
      }
      step();
    }

    // --- ×¤×•× ×§×¦×™×•×ª × ×•×¡×¤×•×ª: ×—×™×¤×•×© ××•×¦×¨×™×, ×¡× ×›×¨×•×Ÿ ××©×ª××©, ×”×ª×—×‘×¨×•×ª ×•×›×•' ---

    // ×—×™×¤×•×© ××•×¦×¨×™× ×œ×¤×™ ××—×¨×•×–×ª
    async function searchProducts(q) {
      const container = document.getElementById('productsContainer');
      if (!container) return;

      container.innerHTML = '<div style="text-align:center;padding:2rem;color:#6c49ff;">××—×¤×© ×ª×•×¦××•×ª...</div>';

      try {
        const res = await fetch(`https://dummyjson.com/products/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        renderProducts(data.products || []);
        document.getElementById('loadMoreBtn').style.display = 'none';
      } catch (err) {
        container.innerHTML = '<div style="text-align:center;padding:2rem;color:#fd52af;">×©×’×™××” ×‘×—×™×¤×•×©</div>';
      }
    }

    // ×¡× ×›×¨×•×Ÿ ××©×ª××© ××§×•××™ ×¢× ×”× ×ª×•× ×™× ×‘-BIN
    async function syncUserWithBin() {
      if (!localStorage.getItem('user')) return;
      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
          headers: { "X-Master-Key": API_KEY }
        });
        const data = await res.json();
        const users = data.record.users || [];
        let localUser = JSON.parse(localStorage.getItem('user') || '{}');
        let binUser = users.find(u => u.username === localUser.username);

        localUser.cartUpdatedAt = localUser.cartUpdatedAt || 0;
        if (binUser) binUser.cartUpdatedAt = binUser.cartUpdatedAt || 0;

        if (binUser && binUser.cartUpdatedAt > localUser.cartUpdatedAt) {
          localStorage.setItem('user', JSON.stringify(binUser));
        } else if (binUser && localUser.cartUpdatedAt > binUser.cartUpdatedAt) {
          let idx = users.findIndex(u => u.username === localUser.username);
          users[idx] = localUser;
          await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": API_KEY
            },
            body: JSON.stringify({ users })
          });
        }
      } catch (err) {
        console.warn("×©×’×™××” ×‘×¡× ×›×¨×•×Ÿ ×¢× BIN:", err);
      }
    }

    // ××¢×‘×¨ ×œ×“×£ ×¤×¨×•×¤×™×œ ××©×ª××©
    function goToProfile() {
      window.location.href = 'profile.html';
    }
    // ×”×ª× ×ª×§×•×ª ××©×ª××©
    function logoutUser() {
      clearUser();
      updateCartCount();
      document.getElementById('loginBtn').style.display = 'inline-block';
      document.getElementById('userAvatar').style.display = 'none';
      showSuccessMessage('×”×ª× ×ª×§×ª ×‘×”×¦×œ×—×”');
      setTimeout(() => location.reload(), 1000);
    }
    // ×”×¦×’×ª ×¤×•×¤××¤ ×”×ª×—×‘×¨×•×ª
    function showLoginPopup() {
      if (document.getElementById("loginPopup")) return;

      const popup = document.createElement('div');
      popup.id = "loginPopup";
      popup.className = "login-popup-bg";
      popup.innerHTML = `
      <div class="login-popup-inner">
        <h3>×¢×œ ×× ×ª ×œ×”×•×¡×™×£ ×œ×¡×œ</h3>
        <div>×™×© ×œ×”×ª×—×‘×¨ ×ª×—×™×œ×” ×œ××¢×¨×›×ª</div>
        <button onclick="window.location.href='login.html'">×”×ª×—×‘×¨×™ ×¢×›×©×™×•</button><br>
        <button class="close-btn" onclick="document.getElementById('loginPopup').remove()">×¡×’×•×¨</button>
      </div>`;
      document.body.appendChild(popup);
      popup.addEventListener('click', (e) => {
        if (e.target === popup) {
          popup.remove();
        }
      });
    }
    // ×”×¦×’×ª ×”×•×“×¢×ª ×”×¦×œ×—×”
    function showSuccessMessage(message) {
      const msg = document.createElement('div');
      msg.style.cssText = `
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white; padding: 1rem 2rem; border-radius: 25px;
      z-index: 10000; font-weight: 600; box-shadow: 0 4px 15px rgba(76,175,80,0.3);
      animation: fadeIn 0.5s ease-out;
    `;
      msg.textContent = message;
      document.body.appendChild(msg);
      setTimeout(() => {
        if (msg.parentNode) msg.remove();
      }, 2000);
    }

    // --- ××ª×—×•×œ ×”×“×£: ×˜×¢×™× ×ª ×ª×¤×¨×™×˜, ××•×¦×¨×™× ×•××‘×¦×¢×™× ---
    document.addEventListener('DOMContentLoaded', async function () {
      await syncUserWithBin();

      if (isUserLoggedIn()) {
        setAvatar();
        document.getElementById('userAvatar').style.display = 'inline-flex';
        document.getElementById('loginBtn').style.display = 'none';
        updateCartCount();
      } else {
        document.getElementById('loginBtn').style.display = 'inline-block';
        document.getElementById('userAvatar').style.display = 'none';
        updateCartCount();
      }

      buildMenu();
      loadProducts();
      loadPromoProducts();

      // ×—×™×¤×•×© ××•×¦×¨×™×
      const searchBox = document.getElementById('searchBox');
      if (searchBox) {
        searchBox.addEventListener('input', async function (e) {
          const q = e.target.value.trim();
          if (!q) {
            loadProducts('', true);
            return;
          }
          searchProducts(q);
        });
      }

      // ×ª×¤×¨×™×˜ ××©×ª××© (××•×•×˜×¨)
      const userAvatar = document.getElementById('userAvatar');
      if (userAvatar) {
        userAvatar.onclick = function (event) {
          event.stopPropagation();
          this.classList.toggle('open');
        };
      }
      document.body.addEventListener('click', function () {
        if (userAvatar) userAvatar.classList.remove('open');
      });
    });

    // --- ×× ×™××¦×™×” ×—×œ×§×” ×œ×¡×¨×˜ ×”××‘×¦×¢×™× ---
    function animatePromoBannerSmooth(container) {
      if (!container) return;

      const items = container.children;
      if (items.length === 0) return;

      let scrollAmount = 0;
      const speed = 0.8; // ××”×™×¨×•×ª ×’×œ×™×œ×”

      function scrollStep() {
        scrollAmount += speed;
        container.scrollLeft = scrollAmount;

        // ×—×•×–×¨×™× ×œ×”×ª×—×œ×” ×›×©××’×™×¢×™× ×œ×¡×•×£
        if (scrollAmount >= container.scrollWidth / 2) {
          scrollAmount = 0;
          container.scrollLeft = 0;
        }
        requestAnimationFrame(scrollStep);
      }

      scrollStep();
    }

  </script>
</body>

</html>