<!DOCTYPE html>
<html lang="he">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>חנות דיגיטלית</title>
  <!-- קישור לקובץ CSS חיצוני לעיצוב -->
  <link rel="stylesheet" href="index.css">
</head>

<body>
  <!-- סרגל ניווט עליון עם לוגו, חיפוש, סל קניות וכניסה -->
  <nav>
    <div class="nav-header">
      <!-- לוגו החנות -->
      <a href="index.html">
        <img src="image/logo.png" class="logo-img" alt="לוגו החנות" />
      </a>

      <!-- תיבת חיפוש מוצרים -->
      <div class="nav-search">
        <input type="text" id="searchBox" placeholder="חיפוש מוצר..." autocomplete="off" />
        <span style="font-size:1.2rem;color:#6c49ff;">🔍</span>
      </div>
      <!-- פעולות משתמש: סל קניות, אווטר, התחברות -->
      <div class="nav-actions">
        <!-- כפתור מעבר לסל הקניות -->
        <button class="cart-btn" onclick="window.location.href='cart.html'">
          <span class="cart-count" id="cartCount">0</span> 🛒 סל
        </button>
        <!-- הצגת אווטר משתמש מחובר -->
        <div class="user-avatar" id="userAvatar" style="display:none;">
          <span id="avatarInitial"></span>
          <div class="user-dropdown" id="userDropdown">
            <button onclick="goToProfile()">פרטים אישיים</button>
            <button onclick="logoutUser()">התנתק</button>
          </div>
        </div>
        <!-- כפתור התחברות -->
        <button class="login-btn" id="loginBtn" onclick="showLoginPopup()">התחבר</button>
      </div>
    </div>
    <!-- תפריט ראשי של קטגוריות -->
    <ul class="menu" id="mainMenu"></ul>
  </nav>

  <!-- באנר מבצעים רץ -->
  <section id="promoBanner" class="promo-container" style="position: relative;">
    <div class="sale-animation">
      <img src="image/sale.png" alt="מבצע">
    </div>
    <div class="promo-slider" id="promoTrack"></div>
  </section>

  <main>
    <!-- כותרת קטגוריה/חיפוש -->
    <div class="products-title" id="productsTitle"></div>
    <!-- אזור הצגת כרטיסי מוצרים -->
    <div class="products-container" id="productsContainer"></div>
    <!-- כפתור טעינת עוד מוצרים -->
    <button class="load-more-btn" id="loadMoreBtn" style="display:none;" onclick="loadMoreProducts()">טען עוד
      מוצרים</button>
  </main>

  <!-- פוטר ליצירת קשר -->
  <footer>
    יצירת קשר: <b>support@onlineShop.co.il</b> | יש לך שאלה? <a href="mailto:support@onlineShop.co.il">פנה אלינו</a>
  </footer>

  <script>
    // --- משתנים גלובליים ---
    // מזהה ה-BIN וה-API KEY לשמירת משתמשים/סלים ב-jsonbin.io
    const BIN_ID = "687d68e6fdac391a2ff106cd";
    const API_KEY = "$2a$10$jUdVbRFsQ.nFPu9sdEhLGuFKyLKnsopNmK7f9K2anJSQ3noWGvHMq";

    // מיפוי קטגוריות ראשיות ותתי קטגוריות
    const categories = {
      'נשים': ['womens-dresses', 'womens-shoes', 'womens-watches', 'womens-bags', 'womens-jewellery'],
      'גברים': ['mens-shirts', 'mens-shoes', 'mens-watches'],
      'טכנולוגיה': ['smartphones', 'laptops', 'tablets', 'mobile-accessories'],
      'יופי': ['beauty', 'skin-care', 'fragrances'],
      'לבית': ['furniture', 'home-decoration', 'kitchen-accessories'],
      'סופר': ['groceries'],
      'אביזרים': ['sports-accessories', 'sunglasses'],
      'רכב': ['motorcycle', 'vehicle'],
      'אופנה': ['tops']
    };

    // מיפוי שם תצוגה עברי לכל תת-קטגוריה
    const catDisplay = {
      'womens-dresses': 'שמלות נשים',
      'womens-shoes': 'נעלי נשים',
      'womens-watches': 'שעוני נשים',
      'womens-bags': 'תיקי נשים',
      'womens-jewellery': 'תכשיטי נשים',
      'mens-shirts': 'חולצות גברים',
      'mens-shoes': 'נעלי גברים',
      'mens-watches': 'שעוני גברים',
      'smartphones': 'סמארטפונים',
      'laptops': 'מחשבים ניידים',
      'tablets': 'טאבלטים',
      'mobile-accessories': 'אביזרי מובייל',
      'beauty': 'יופי',
      'skin-care': 'טיפוח העור',
      'fragrances': 'בשמים',
      'furniture': 'רהיטים',
      'home-decoration': 'עיצוב הבית',
      'kitchen-accessories': 'אביזרי מטבח',
      'groceries': 'מכולת',
      'sports-accessories': 'אביזרי ספורט',
      'sunglasses': 'משקפי שמש',
      'motorcycle': 'אופנועים',
      'vehicle': 'רכבים',
      'tops': 'חולצות וטופים'
    };

    // --- פונקציות ניהול משתמשים וסל קניות ---

    // בדיקה האם יש משתמש מחובר
    function isUserLoggedIn() {
      return !!localStorage.getItem('user');
    }
    // שליפת אובייקט המשתמש מה-localStorage
    function getUser() {
      try {
        return JSON.parse(localStorage.getItem('user') || '{}');
      } catch {
        return {};
      }
    }
    // שמירת משתמש ל-localStorage
    function setUser(userObj) {
      localStorage.setItem('user', JSON.stringify(userObj));
    }
    // מחיקת משתמש מה-localStorage
    function clearUser() {
      localStorage.removeItem('user');
    }

    // הצגת האווטר כאשר משתמש מחובר
    function setAvatar() {
      const user = getUser();
      let displayName = user.username || '';
      const loginBtn = document.getElementById('loginBtn');
      const userAvatar = document.getElementById('userAvatar');
      const avatarInitial = document.getElementById('avatarInitial');
      if (loginBtn) loginBtn.style.display = 'none';
      if (userAvatar) userAvatar.style.display = 'inline-flex';
      if (avatarInitial) avatarInitial.textContent = displayName.charAt(0) || 'מ';
    }

    // עדכון ספירת פריטים בסל קניות
    function updateCartCount() {
      let cart = getUserCart();
      let sum = cart.reduce((a, b) => a + (b.quantity || 1), 0);
      const cartCountEl = document.getElementById('cartCount');
      if (cartCountEl) cartCountEl.textContent = sum;
    }

    // שליפת סל קניות של המשתמש
    function getUserCart() {
      let user = JSON.parse(localStorage.getItem('user') || '{}');
      return Array.isArray(user.cart) ? user.cart : [];
    }

    // --- הוספת מוצר לסל קניות (כולל מבצע) ---
    async function addToCart(id, title, thumbnail, price, event, promoPrice = null) {
      if (!isUserLoggedIn()) {
        showLoginPopup();
        return;
      }
      let user = getUser();
      let cart = Array.isArray(user.cart) ? user.cart : [];

      // בדיקה האם המוצר כבר בסל
      let existing = cart.find(item => item.id === id);
      if (existing) {
        existing.quantity += 1;
      } else {
        cart.push({
          id,
          title,
          thumbnail,
          price: promoPrice !== null ? promoPrice : price, // שמירת מחיר מבצע אם יש
          originalPrice: price,
          quantity: 1
        });
      }

      user.cart = cart;
      user.cartUpdatedAt = Date.now();
      setUser(user);
      updateCartCount();

      // אנימציה/הודעה בכפתור הוספה לסל
      if (event) {
        const btn = event.target || event;
        const originalText = btn.textContent;
        const originalBg = btn.style.background;
        btn.textContent = promoPrice !== null ? "נוסף למבצע ✓" : "נוסף לסל ✓";
        btn.style.background = "#4CAF50"; // ירוק
        btn.disabled = true;
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = originalBg;
          btn.disabled = false;
        }, 1500);
      }

      // שמירה לשרת BIN (jsonbin)
      setTimeout(async () => {
        try {
          const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
            headers: { "X-Master-Key": API_KEY }
          });
          const data = await res.json();
          const users = data.record.users || [];
          let idx = users.findIndex(u => u.username === user.username);
          if (idx !== -1) {
            users[idx].cart = cart;
            users[idx].cartUpdatedAt = user.cartUpdatedAt;
            await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                "X-Master-Key": API_KEY
              },
              body: JSON.stringify({ users })
            });
          }
        } catch (err) {
          console.warn('שגיאה בשמירת הסל:', err);
        }
      }, 200);
    }

    // הוספת מוצר מהחלון של מבצע
    function addToCartFromWindowPromo(productKey, buttonElement) {
      const productData = window[productKey];
      if (productData) {
        addToCart(
          productData.id,
          productData.title,
          productData.thumbnail,
          productData.price,
          buttonElement,
          productData.promoPrice
        );
      }
    }

    // --- בניית תפריט קטגוריות ראשי ודינמי ---
    function buildMenu() {
      const mainMenu = document.getElementById('mainMenu');
      if (!mainMenu) return;

      mainMenu.innerHTML = '';
      Object.entries(categories).forEach(([mainCat, subcats]) => {
        let li = document.createElement('li');
        li.className = 'menu-item';
        li.tabIndex = 0;
        li.textContent = mainCat;

        li.onclick = async () => {
          closeAllMenus();
          document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('selected'));
          li.classList.add('selected');
          let allProducts = [];
          for (let cat of subcats) {
            try {
              const res = await fetch(`https://dummyjson.com/products/category/${cat}`);
              const data = await res.json();
              allProducts = allProducts.concat(data.products || []);
            } catch (err) {
              console.error('שגיאה בטעינת קטגוריה:', cat, err);
            }
          }
          renderProducts(allProducts);
          document.getElementById('productsTitle').textContent = 'כל המוצרים בקטגוריה: ' + mainCat;
          document.getElementById('loadMoreBtn').style.display = 'none';
        };

        // בניית תפריט משנה (תתי קטגוריות)
        if (subcats.length) {
          let submenu = document.createElement('ul');
          submenu.className = 'submenu';
          subcats.forEach(sc => {
            let btn = document.createElement('button');
            btn.className = 'submenu-btn';
            btn.textContent = catDisplay[sc];
            btn.onclick = (e) => {
              e.stopPropagation();
              closeAllMenus();
              document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('selected'));
              li.classList.add('selected');
              loadProducts(sc, true);
              document.getElementById('productsTitle').textContent = 'כל המוצרים בקטגוריה: ' + catDisplay[sc];
              document.getElementById('loadMoreBtn').style.display = 'none';
            };
            submenu.appendChild(btn);
          });
          li.appendChild(submenu);
          li.addEventListener('mouseenter', () => {
            closeAllMenus();
            li.classList.add('open');
          });
          li.addEventListener('mouseleave', () => {
            li.classList.remove('open');
          });
        }
        mainMenu.appendChild(li);
      });
    }
    // סגירת כל התפריטים (משנה)
    function closeAllMenus() {
      document.querySelectorAll('.menu-item.open').forEach(el => el.classList.remove('open'));
    }

    // --- טעינת מוצרים דינאמית ---
    let allProducts = [], currPage = 0, currCat = '', isLoading = false, hasMoreProducts = true;
    const PRODUCTS_PER_PAGE = 20;
    async function loadProducts(cat = '', reset = true) {
      if (isLoading) return;
      isLoading = true;
      updateLoadMoreButton();

      try {
        if (reset) {
          currCat = cat;
          currPage = 0;
          allProducts = [];
          hasMoreProducts = true;
          const container = document.getElementById('productsContainer');
          if (container) container.innerHTML = '<div style="text-align:center;padding:2rem;color:#6c49ff;font-size:1.2rem;">טוען מוצרים...</div>';
        }

        let skip = currPage * PRODUCTS_PER_PAGE;
        let url = cat
          ? `https://dummyjson.com/products/category/${cat}?limit=${PRODUCTS_PER_PAGE}&skip=${skip}`
          : `https://dummyjson.com/products?limit=${PRODUCTS_PER_PAGE}&skip=${skip}`;

        const res = await fetch(url);
        const data = await res.json();
        let products = data.products || [];

        allProducts = reset ? products : [...allProducts, ...products];
        hasMoreProducts = products.length === PRODUCTS_PER_PAGE;
        currPage++;

        renderProducts(allProducts);
      } catch (err) {
        const container = document.getElementById('productsContainer');
        if (container) {
          container.innerHTML = '<div style="text-align:center;padding:2rem;color:#fd52af;">שגיאה בטעינת המוצרים</div>';
        }
      } finally {
        isLoading = false;
        updateLoadMoreButton();
      }
    }
    // טעינת עמוד נוסף של מוצרים
    function loadMoreProducts() {
      const searchBox = document.getElementById('searchBox');
      if (searchBox && searchBox.value.trim()) return;
      if (isLoading) {
        isLoading = false;
        return;
      }
      loadProducts(currCat, false).catch(() => {
        isLoading = false;
        updateLoadMoreButton();
      });
    }
    // עדכון סטטוס כפתור "טען עוד מוצרים"
    function updateLoadMoreButton() {
      const btn = document.getElementById('loadMoreBtn');
      if (!btn) return;
      if (hasMoreProducts && allProducts.length > 0) {
        btn.style.display = 'block';
        btn.disabled = isLoading;
        btn.textContent = isLoading ? 'טוען...' : 'טען עוד מוצרים';
      } else {
        btn.style.display = 'none';
      }
    }

    // --- הצגת כרטיסי מוצרים בדף הראשי ---
    function renderProducts(products) {
      const container = document.getElementById('productsContainer');
      if (!container) return;
      if (!products || products.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:2rem;color:#6c49ff;">לא נמצאו מוצרים</div>';
        return;
      }

      const html = products.map((prod, index) => {
        const productKey = `product_${prod.id}_${index}`;
        window[productKey] = {
          id: prod.id,
          title: prod.title,
          thumbnail: prod.thumbnail,
          price: prod.price,
          promoPrice: null
        };

        const safeTitle = (prod.title || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
        const safeThumbnail = (prod.thumbnail || '').replace(/"/g, '&quot;');

        return `
        <div class="product-card">
          <a href="product.html?id=${prod.id}&promo=${prod.promoPrice}" style="text-decoration: none; color: inherit; display: block;">
            <img src="${safeThumbnail}" alt="${safeTitle}" class="product-img" onerror="this.src='https://via.placeholder.com/100x100?text=No+Image'">
            <h3 class="product-title">${safeTitle}</h3>
            <p class="product-price">$${prod.price || 0}</p>
          </a>
          <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCartFromWindowPromo('${productKey}', this)">הוסף לסל 🛒</button>
        </div>
      `;
      }).join('');

      container.innerHTML = html;
    }

    // --- טעינת מוצרים עם מבצע לסרט המבצעים ---
    async function loadPromoProducts() {
      try {
        let allPromoCandidates = [];
        const categoryArrays = Object.values(categories);
        const flatCategories = categoryArrays.flat();

        // קריאות מקבילות לכל הקטגוריות
        const fetches = flatCategories.map(cat => fetch(`https://dummyjson.com/products/category/${cat}?limit=20`));
        const results = await Promise.all(fetches);

        for (const res of results) {
          const data = await res.json();
          allPromoCandidates = allPromoCandidates.concat(data.products || []);
        }

        // בחירת 10 מוצרים אקראיים
        const selected = getRandomUnique(allPromoCandidates, 10);
        selected.forEach(prod => {
          prod.promoPrice = Math.round(prod.price * 0.9);
        });

        renderPromoBanner(selected);
      } catch (err) {
        console.error('שגיאה בטעינת מבצעים:', err);
      }
    }

    // --- שליפת n מוצרים אקראיים מהמערך ---
    function getRandomUnique(arr, n) {
      const result = [];
      const taken = new Set();
      while (result.length < n && result.length < arr.length) {
        const idx = Math.floor(Math.random() * arr.length);
        if (!taken.has(idx)) {
          taken.add(idx);
          result.push(arr[idx]);
        }
      }
      return result;
    }

    // --- הצגת סרט המבצעים (קארוסל מוצרים) ---
    function renderPromoBanner(products) {
      const promoTrack = document.getElementById('promoTrack');
      if (!promoTrack) return;

      const html = products.map((prod, index) => {
        const productKey = `promo_product_${prod.id}_${index}`;
        window[productKey] = prod;

        return `
        <div class="promo-item">
          <div class="promo-badge">10% מבצע</div>
      <a href="product.html?id=${prod.id}&promo=${prod.promoPrice}" style="text-decoration: none; color: inherit; display: block;">
            <img src="${prod.thumbnail}" alt="${prod.title}">
            <div class="promo-title">${prod.title}</div>
            <div>
              <span class="promo-price">$${prod.promoPrice}</span>
              <span class="promo-original-price">$${prod.price}</span>
            </div>
          </a>
          <button class="add-to-cart-btn" onclick="event.stopPropagation(); addToCartFromWindowPromo('${productKey}', this)">הוסף למבצע 🛒</button>
        </div>
      `;
      }).join('');

      // שכפול התוכן כדי ליצור ריצה אינסופית של המבצעים
      promoTrack.innerHTML = html + html;
    }

    // --- אנימציית גלילה אוטומטית לסרט המבצעים ---
    function animatePromoBanner(container) {
      let scrollPos = 0;
      const speed = 0.5; // מהירות גלילה

      // נדביק את התוכן פעמיים כדי לאפשר לולאה אינסופית
      container.innerHTML += container.innerHTML;
      const scrollWidth = container.scrollWidth / 2;

      function step() {
        scrollPos += speed;
        if (scrollPos >= scrollWidth) scrollPos = 0;
        container.scrollLeft = scrollPos;
        requestAnimationFrame(step);
      }
      step();
    }

    // --- פונקציות נוספות: חיפוש מוצרים, סנכרון משתמש, התחברות וכו' ---

    // חיפוש מוצרים לפי מחרוזת
    async function searchProducts(q) {
      const container = document.getElementById('productsContainer');
      if (!container) return;

      container.innerHTML = '<div style="text-align:center;padding:2rem;color:#6c49ff;">מחפש תוצאות...</div>';

      try {
        const res = await fetch(`https://dummyjson.com/products/search?q=${encodeURIComponent(q)}`);
        const data = await res.json();
        renderProducts(data.products || []);
        document.getElementById('loadMoreBtn').style.display = 'none';
      } catch (err) {
        container.innerHTML = '<div style="text-align:center;padding:2rem;color:#fd52af;">שגיאה בחיפוש</div>';
      }
    }

    // סנכרון משתמש מקומי עם הנתונים ב-BIN
    async function syncUserWithBin() {
      if (!localStorage.getItem('user')) return;
      try {
        const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
          headers: { "X-Master-Key": API_KEY }
        });
        const data = await res.json();
        const users = data.record.users || [];
        let localUser = JSON.parse(localStorage.getItem('user') || '{}');
        let binUser = users.find(u => u.username === localUser.username);

        localUser.cartUpdatedAt = localUser.cartUpdatedAt || 0;
        if (binUser) binUser.cartUpdatedAt = binUser.cartUpdatedAt || 0;

        if (binUser && binUser.cartUpdatedAt > localUser.cartUpdatedAt) {
          localStorage.setItem('user', JSON.stringify(binUser));
        } else if (binUser && localUser.cartUpdatedAt > binUser.cartUpdatedAt) {
          let idx = users.findIndex(u => u.username === localUser.username);
          users[idx] = localUser;
          await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": API_KEY
            },
            body: JSON.stringify({ users })
          });
        }
      } catch (err) {
        console.warn("שגיאה בסנכרון עם BIN:", err);
      }
    }

    // מעבר לדף פרופיל משתמש
    function goToProfile() {
      window.location.href = 'profile.html';
    }
    // התנתקות משתמש
    function logoutUser() {
      clearUser();
      updateCartCount();
      document.getElementById('loginBtn').style.display = 'inline-block';
      document.getElementById('userAvatar').style.display = 'none';
      showSuccessMessage('התנתקת בהצלחה');
      setTimeout(() => location.reload(), 1000);
    }
    // הצגת פופאפ התחברות
    function showLoginPopup() {
      if (document.getElementById("loginPopup")) return;

      const popup = document.createElement('div');
      popup.id = "loginPopup";
      popup.className = "login-popup-bg";
      popup.innerHTML = `
      <div class="login-popup-inner">
        <h3>על מנת להוסיף לסל</h3>
        <div>יש להתחבר תחילה למערכת</div>
        <button onclick="window.location.href='login.html'">התחברי עכשיו</button><br>
        <button class="close-btn" onclick="document.getElementById('loginPopup').remove()">סגור</button>
      </div>`;
      document.body.appendChild(popup);
      popup.addEventListener('click', (e) => {
        if (e.target === popup) {
          popup.remove();
        }
      });
    }
    // הצגת הודעת הצלחה
    function showSuccessMessage(message) {
      const msg = document.createElement('div');
      msg.style.cssText = `
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white; padding: 1rem 2rem; border-radius: 25px;
      z-index: 10000; font-weight: 600; box-shadow: 0 4px 15px rgba(76,175,80,0.3);
      animation: fadeIn 0.5s ease-out;
    `;
      msg.textContent = message;
      document.body.appendChild(msg);
      setTimeout(() => {
        if (msg.parentNode) msg.remove();
      }, 2000);
    }

    // --- אתחול הדף: טעינת תפריט, מוצרים ומבצעים ---
    document.addEventListener('DOMContentLoaded', async function () {
      await syncUserWithBin();

      if (isUserLoggedIn()) {
        setAvatar();
        document.getElementById('userAvatar').style.display = 'inline-flex';
        document.getElementById('loginBtn').style.display = 'none';
        updateCartCount();
      } else {
        document.getElementById('loginBtn').style.display = 'inline-block';
        document.getElementById('userAvatar').style.display = 'none';
        updateCartCount();
      }

      buildMenu();
      loadProducts();
      loadPromoProducts();

      // חיפוש מוצרים
      const searchBox = document.getElementById('searchBox');
      if (searchBox) {
        searchBox.addEventListener('input', async function (e) {
          const q = e.target.value.trim();
          if (!q) {
            loadProducts('', true);
            return;
          }
          searchProducts(q);
        });
      }

      // תפריט משתמש (אווטר)
      const userAvatar = document.getElementById('userAvatar');
      if (userAvatar) {
        userAvatar.onclick = function (event) {
          event.stopPropagation();
          this.classList.toggle('open');
        };
      }
      document.body.addEventListener('click', function () {
        if (userAvatar) userAvatar.classList.remove('open');
      });
    });

    // --- אנימציה חלקה לסרט המבצעים ---
    function animatePromoBannerSmooth(container) {
      if (!container) return;

      const items = container.children;
      if (items.length === 0) return;

      let scrollAmount = 0;
      const speed = 0.8; // מהירות גלילה

      function scrollStep() {
        scrollAmount += speed;
        container.scrollLeft = scrollAmount;

        // חוזרים להתחלה כשמגיעים לסוף
        if (scrollAmount >= container.scrollWidth / 2) {
          scrollAmount = 0;
          container.scrollLeft = 0;
        }
        requestAnimationFrame(scrollStep);
      }

      scrollStep();
    }

  </script>
</body>

</html>